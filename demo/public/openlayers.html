<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bathymetry Demo (OpenLayers)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.3.1/ol.css">
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .info { position: absolute; left: 12px; top: 12px; background: rgba(255,255,255,0.9); padding: 12px;
            border-radius: 10px; font: 12px/1.4 system-ui; max-width: 380px; z-index: 10; }
    .info label { display: block; margin-top: 6px; font-weight: 600; }
    .info select { width: 100%; margin-top: 4px; }
    .info ul { padding-left: 18px; margin: 6px 0 0; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="info">
  <b>Bathymetry demo (OpenLayers)</b><br/>
  <span>Available layers from <code>/health</code>:</span>
  <ul id="layer-status"></ul>
  <label for="layer-select">Select layer to visualize</label>
  <select id="layer-select" aria-label="Select layer to visualize"></select>
</div>

<script type="module">
  import Map from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/Map.js';
  import View from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/View.js';
  import TileLayer from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/layer/Tile.js';
  import VectorTileLayer from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/layer/VectorTile.js';
  import OSM from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/source/OSM.js';
  import XYZ from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/source/XYZ.js';
  import VectorTileSource from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/source/VectorTile.js';
  import MVT from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/format/MVT.js';
  import Stroke from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/style/Stroke.js';
  import Style from 'https://cdn.jsdelivr.net/npm/ol@10.3.1/style/Style.js';

  const base = `${window.location.origin}/tiles`;

  const osm = new TileLayer({ source: new OSM() });
  const bathy = new TileLayer({ opacity: 0.55, visible: false, source: new XYZ({ url: `${base}/bathy/{z}/{x}/{y}.png`, crossOrigin: "anonymous" }) });
  const hillshade = new TileLayer({ opacity: 0.45, visible: false, source: new XYZ({ url: `${base}/hillshade/{z}/{x}/{y}.png`, crossOrigin: "anonymous" }) });
  const slope = new TileLayer({ opacity: 0.45, visible: false, source: new XYZ({ url: `${base}/slope/{z}/{x}/{y}.png`, crossOrigin: "anonymous" }) });

  const contours = new VectorTileLayer({
    visible: false,
    source: new VectorTileSource({ format: new MVT(), url: `${base}/vector/{z}/{x}/{y}.pbf` }),
    style: new Style({ stroke: new Stroke({ width: 1.0 }) })
  });

  const overlayLayers = [
    { id: "contours", label: "Contours (vector)", healthKey: "vector_exists", layer: contours },
    { id: "bathy", label: "Bathymetry (raster)", healthKey: "bathy_exists", layer: bathy },
    { id: "hillshade", label: "Hillshade (raster)", healthKey: "hillshade_exists", layer: hillshade },
    { id: "slope", label: "Slope (raster)", healthKey: "slope_exists", layer: slope }
  ];

  const map = new Map({
    target: 'map',
    layers: [osm, bathy, hillshade, slope, contours],
    view: new View({ center: [1580000, 4870000], zoom: 10, projection: 'EPSG:3857' })
  });

  const statusList = document.getElementById("layer-status");
  const select = document.getElementById("layer-select");

  function setOverlayVisibility(selectedId) {
    overlayLayers.forEach((entry) => {
      entry.layer.setVisible(entry.id === selectedId);
    });
  }

  fetch(`${window.location.origin}/health`)
    .then((response) => response.json())
    .then((health) => {
      statusList.innerHTML = "";
      select.innerHTML = "";

      const available = overlayLayers.filter((layer) => health[layer.healthKey]);
      const unavailable = overlayLayers.filter((layer) => !health[layer.healthKey]);

      available.forEach((layer) => {
        const item = document.createElement("li");
        item.textContent = `${layer.label} (available)`;
        statusList.appendChild(item);

        const option = document.createElement("option");
        option.value = layer.id;
        option.textContent = layer.label;
        select.appendChild(option);
      });

      unavailable.forEach((layer) => {
        const item = document.createElement("li");
        item.textContent = `${layer.label} (missing)`;
        statusList.appendChild(item);
      });

      if (available.length > 0) {
        select.value = available[0].id;
        setOverlayVisibility(available[0].id);
      } else {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "No overlay layers available";
        select.appendChild(option);
        select.disabled = true;
      }
    })
    .catch(() => {
      statusList.innerHTML = "<li>Unable to load /health</li>";
      select.innerHTML = "<option value=\"\">Unavailable</option>";
      select.disabled = true;
    });

  select.addEventListener("change", (event) => {
    if (event.target.value) {
      setOverlayVisibility(event.target.value);
    }
  });
</script>
</body>
</html>
