<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bathymetry Demo (MapLibre)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .info { position: absolute; left: 12px; top: 12px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 10px; font: 12px/1.4 system-ui; max-width: 380px;}
    .info label { display: block; margin-top: 6px; font-weight: 600; }
    .info select { width: 100%; margin-top: 4px; }
    .info ul { padding-left: 18px; margin: 6px 0 0; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="info">
  <b>Bathymetry demo (MapLibre)</b><br/>
  <span>Available layers from <code>/health</code>:</span>
  <ul id="layer-status"></ul>
  <label for="layer-select">Select layer to visualize</label>
  <select id="layer-select" aria-label="Select layer to visualize"></select>
</div>

<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script>
  const base = `${window.location.origin}/tiles`;

  const overlays = [
    { id: "contours", label: "Contours (vector)", healthKey: "vector_exists" },
    { id: "bathy", label: "Bathymetry (raster)", healthKey: "bathy_exists" },
    { id: "hillshade", label: "Hillshade (raster)", healthKey: "hillshade_exists" },
    { id: "slope", label: "Slope (raster)", healthKey: "slope_exists" }
  ];

  const map = new maplibregl.Map({
    container: "map",
    style: {
      version: 8,
      sources: {
        osm: {
          type: "raster",
          tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256,
          attribution: "Â© OpenStreetMap"
        },
        bathy: { type: "raster", tiles: [`${base}/bathy/{z}/{x}/{y}.png`], tileSize: 256 },
        hillshade: { type: "raster", tiles: [`${base}/hillshade/{z}/{x}/{y}.png`], tileSize: 256 },
        slope: { type: "raster", tiles: [`${base}/slope/{z}/{x}/{y}.png`], tileSize: 256 },
        contours: { type: "vector", tiles: [`${base}/vector/{z}/{x}/{y}.pbf`], minzoom: 0, maxzoom: 22 }
      },
      layers: [
        { id: "osm", type: "raster", source: "osm" },
        { id: "bathy", type: "raster", source: "bathy", paint: { "raster-opacity": 0.55 }, layout: { visibility: "none" } },
        { id: "hillshade", type: "raster", source: "hillshade", paint: { "raster-opacity": 0.45 }, layout: { visibility: "none" } },
        { id: "slope", type: "raster", source: "slope", paint: { "raster-opacity": 0.45 }, layout: { visibility: "none" } },
        { id: "contours", type: "line", source: "contours", "source-layer": "bathy_contours",
          paint: { "line-width": 1.0, "line-opacity": 0.9 }, layout: { visibility: "none" } }
      ]
    },
    center: [14.15, 40.75],
    zoom: 10
  });

  const statusList = document.getElementById("layer-status");
  const select = document.getElementById("layer-select");

  function setOverlayVisibility(selectedId) {
    overlays.forEach((layer) => {
      const visibility = layer.id === selectedId ? "visible" : "none";
      if (map.getLayer(layer.id)) {
        map.setLayoutProperty(layer.id, "visibility", visibility);
      }
    });
  }

  map.on("load", () => {
    map.addControl(new maplibregl.NavigationControl(), "top-right");

    fetch(`${window.location.origin}/health`)
      .then((response) => response.json())
      .then((health) => {
        statusList.innerHTML = "";
        select.innerHTML = "";

        const available = overlays.filter((layer) => health[layer.healthKey]);
        const unavailable = overlays.filter((layer) => !health[layer.healthKey]);

        available.forEach((layer) => {
          const item = document.createElement("li");
          item.textContent = `${layer.label} (available)`;
          statusList.appendChild(item);

          const option = document.createElement("option");
          option.value = layer.id;
          option.textContent = layer.label;
          select.appendChild(option);
        });

        unavailable.forEach((layer) => {
          const item = document.createElement("li");
          item.textContent = `${layer.label} (missing)`;
          statusList.appendChild(item);
        });

        if (available.length > 0) {
          select.value = available[0].id;
          setOverlayVisibility(available[0].id);
        } else {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No overlay layers available";
          select.appendChild(option);
          select.disabled = true;
        }
      })
      .catch(() => {
        statusList.innerHTML = "<li>Unable to load /health</li>";
        select.innerHTML = "<option value=\"\">Unavailable</option>";
        select.disabled = true;
      });
  });

  select.addEventListener("change", (event) => {
    if (event.target.value) {
      setOverlayVisibility(event.target.value);
    }
  });
</script>
</body>
</html>
